/*
[COMMIT]
fix: 3ac6487 
parent: 3b5e159

[COMPILE]
compiled with GCC 10.04, defconfig, with KASAN
*/

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <linux/perf_event.h>
#include <sys/ioctl.h>
#include <linux/perf_event.h>
#include <asm/unistd.h>
#include <string.h>
#include <errno.h>
#include <err.h>
#include <sched.h>
#include <x86intrin.h>
#include <sys/wait.h>

unsigned long racee_delay=0, racer_delay=0;

static int fd_hard, fd_soft, group_leader_fd;
static pid_t cur_pid;
static struct perf_event_attr hard_pe, soft_pe;

static long perf_event_open(struct perf_event_attr *hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags)
{
  int ret;

  ret = syscall(__NR_perf_event_open, hw_event, pid, cpu, group_fd, flags);
  return ret;
}

static void perf_attr_prepare(struct perf_event_attr *pe, int type, unsigned long config)
{
  memset(pe, 0, sizeof(struct perf_event_attr));
  pe->type = type;
  pe->size = sizeof(struct perf_event_attr);
  pe->config = config;
  pe->exclude_kernel = 1;
  pe->exclude_hv = 1;
}

void sys_racee(void)
{
  fd_hard = perf_event_open(&hard_pe, cur_pid, -1, group_leader_fd, 0);
  if (fd_hard < 0)
    warn("[-] open hard event failed");
}

void sys_racer(void)
{
  fd_soft = perf_event_open(&soft_pe, cur_pid, -1, group_leader_fd, 0);
  if (fd_soft < 0)
    warn("[-] open soft event failed");
}

void setup_one()
{
  struct perf_event_attr pe;

  cur_pid = getpid();
  perf_attr_prepare(&pe, PERF_TYPE_SOFTWARE, PERF_COUNT_SW_CONTEXT_SWITCHES);
  group_leader_fd = perf_event_open(&pe, 0, -1, -1, 0);
  if (group_leader_fd <= 0) {
    printf("Failed to open group leader (err: %d)\n", -errno);
    exit(EXIT_FAILURE);
  }

  perf_attr_prepare(&hard_pe, PERF_TYPE_HARDWARE, PERF_COUNT_HW_CPU_CYCLES);
  perf_attr_prepare(&soft_pe, PERF_TYPE_SOFTWARE, PERF_COUNT_SW_CONTEXT_SWITCHES);
}

void cleanup_one()
{
  close(group_leader_fd);
  close(fd_hard);
  close(fd_soft);
}

void do_cleanup(void)
{
  return;
}

void do_setup(void)
{
  return;
}

int sanity_check(void)
{
  return 0;
}