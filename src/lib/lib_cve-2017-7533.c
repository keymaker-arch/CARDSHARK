/*
[COMMIT]
fix: 49d31c2f389
parent: a8e2b63677

[COMPILE]
compiled with GCC 6.5, defconfig, with KASAN
*/

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <fcntl.h>
#include <string.h>
#include <sys/inotify.h>

#define DUMMY_DIR "test_dir"
#define DUMMY_NAME "f"
#define DUMMY_NAME_LONG "bbbb3210321032103210\x30\xff\xff\x31\xff\xff\xff\xff"

unsigned long long racee_delay, racer_delay;
static int fd;

static void notify_thread_func(void) 
{
    int fd, wd;

    fd = inotify_init1(IN_NONBLOCK);
    if (fd == -1) {
        perror("inotify_init1");
        exit(-1);
    }

    wd = inotify_add_watch(fd, DUMMY_DIR, IN_OPEN | IN_CLOSE| IN_ACCESS);
    if (wd == -1) {
        perror("inotify_add_watch");
        exit(-1);
    }
}

void do_setup(void)
{
    system("mkdir test_dir; touch "DUMMY_DIR"/"DUMMY_NAME);
    notify_thread_func();
}

void setup_one(void)
{
    return;
}

void sys_racee(void)
{
    fd = open(DUMMY_DIR"/"DUMMY_NAME, O_RDWR);
}

void sys_racer(void)
{
    rename (DUMMY_DIR"/"DUMMY_NAME, DUMMY_DIR"/"DUMMY_NAME_LONG);
}

void cleanup_one(void)
{
    close(fd);
    rename (DUMMY_DIR"/"DUMMY_NAME_LONG, DUMMY_DIR"/"DUMMY_NAME);
}

void do_cleanup(void)
{
    system("rm -r "DUMMY_DIR);
    return;
}

int sanity_check(void)
{
    do_setup();
    setup_one();
    sys_racee();
    sys_racer();
    cleanup_one();
    do_cleanup();
    return 0;
}